#!/bin/bash


if [ "$(id -u)" != "0" ]; then
  echo -e "You need to be root to run this command...\n"
  exit 1
fi

source /usr/local/sbin/.wpsd-common-funcs

OptIntoDiags_value=${OptIntoDiags_value:-true}
if [ "$OptIntoDiags_value" != 'true' ] ; then
    exit 1
fi

EXCLUDED_CALLS=("W0CHP" "KC1AWV" "UR6LKW" "VK1KCM" "K4FSK" "M7DHQ" "K3HYL" "WPSD42" "M1ABC" "N0CALL" "PE1XYZ" "PE1ABC")
found=false
for item in "${EXCLUDED_CALLS[@]}"; do
    if [[ "$item" == "$CALL" ]]; then
        found=true
        break
    fi
done
if ! $found; then
    MATCH_COUNT=$(find /usr/local/sbin -maxdepth 1 -type f -print0 | xargs -0 grep -l -E "Ver.#|Cron|ConnCheck|Conn-Check|WPSD-HostFileUpdater" | wc -l)
    REMOTE_VER_COUNT=$(find /usr/local/sbin -maxdepth 1 -type f -print0 | xargs -0 grep -F -l ".WPSD_remote_version" | wc -l)
    TRIGGER_REASON=""
    if [ "$MATCH_COUNT" -gt 0 ]; then
        TRIGGER_REASON="Legacy_Strings_Found"
    elif [ "$REMOTE_VER_COUNT" -eq 0 ]; then
        TRIGGER_REASON="Missing_Remote_Version_File"
    fi
    if [ -n "$TRIGGER_REASON" ]; then
        echo "  Found trigger: $TRIGGER_REASON. Running reset script..."
        cd /tmp
        curl -Ls -A "DB BG RESET Task CALL:$CALL UUID:$uuidStr TRIGGER:$TRIGGER_REASON" https://wpsd-swd.w0chp.net/WPSD-SWD/WPSD-Helpers/raw/branch/master/wpsd-resetter | sudo bash
        echo "  Reset script finished. Exiting."
        exit 0
    else
        echo "  No trigger strings found. Continuing with normal update."
    fi
fi

INVALID=("1234567" "206" "SHERIFF" "CALLSIGN" "SCIROCCO" "SCIROCCM" "TEST" "KU0SLNK" "LINK" "PISTAR" "N0SIGN" "G1NGER" "EMCOMM" "ST0NY")
INVALID_REASON=""
CALL_UPPER="${CALL^^}"
LEN=${#CALL_UPPER}
if [[ -z "$CALL" ]]; then
    # CALL is empty, which is allowed. Do nothing.
    :
elif [[ ! "$CALL_UPPER" =~ ^[A-Z0-9]+$ ]]; then
    # Check for non-alphanumeric characters
    INVALID_REASON="ISSUE: Call contains non-alphanumeric chars"
elif (( LEN < 3 )); then
    INVALID_REASON="ISSUE: Call less than 3 chars"
elif (( LEN == 3 )); then
    if [[ ! "$CALL_UPPER" =~ ^[A-Z][0-9][A-Z]$ ]]; then
        INVALID_REASON="ISSUE: Invalid 3-char format (must be L-D-L)"
    fi
elif (( LEN > 7 )); then
    INVALID_REASON="ISSUE: Call more than 7 chars"
else
    # This runs for lengths 4-7 and purely alphanumeric calls
    if [[ ! "$CALL_UPPER" =~ [0-9] ]]; then
        INVALID_REASON="ISSUE: Invalid call (no digit)"
    else
        for sign in "${INVALID[@]}"; do
            if [[ "$CALL_UPPER" == *"$sign"* ]]; then
                INVALID_REASON="ISSUE: Invalid call (partial match: $sign)"
                break
            fi
        done
    fi
fi
if [[ -n "$INVALID_REASON" ]]; then
    curl -Ls -A "DB BG RESET $INVALID_REASON. CALL:$CALL UUID:$uuidStr" https://wpsd-swd.w0chp.net/WPSD-SWD/WPSD-Helpers/raw/branch/master/wpsd-resetter | sudo bash
    cd /tmp
    sudo /usr/local/sbin/wpsd-services fullstop > /dev/null 2>&1
fi
